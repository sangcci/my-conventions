# ì™¸ë¶€ í™˜ê²½ ì„¤ì •

- ì™¸ë¶€ ëª¨ë“ˆì˜ ì„¤ì •ì— í•„ìš”í•œ ë³€ìˆ˜
- ì–´í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œì— ë…¸ì¶œë˜ê¸°ì— ë¶€ë‹´ìŠ¤ëŸ¬ìš´ ë³€ìˆ˜

# flow

1. ì™¸ë¶€ ì†ì„± ê°’ ì¸ì‹
   
   ì–´í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œ ì™¸ë¶€ ì†ì„± ê°’ì„ ì¸ì‹í•˜ì—¬ `Environment`ì— ì €ì¥í•œë‹¤.
2. ì–´í”Œë¦¬ì¼€ì´ì…˜ì— ì£¼ì…

   í•´ë‹¹ ê°’ë“¤ì„ êº¼ë‚´ì„œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì— ì£¼ì…í•œë‹¤.

---

# ì™¸ë¶€ ì†ì„± ê°’ ì¸ì‹

### PropertySource
> Springì—ì„œ PropertySoruceë¼ëŠ” ìë£Œêµ¬ì¡°ë¥¼ í†µí•´ ì™¸ë¶€ ì†ì„± ê°’ì„ ì €ì¥í•˜ì—¬ Environment Abstraction ê¸°ëŠ¥ì„ ì§€ì›í•œë‹¤.

ğŸ’¡**ì²˜ìŒ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œ ì¸ì‹í•œë‹¤!**

1. `.properties` ë˜ëŠ” `PropertySources.class`ì— í™˜ê²½ ë³€ìˆ˜ ë“±ë¡
2. ë“±ë¡í•˜ê³  ì‹¶ì€ `Config` í´ë˜ìŠ¤ì— `@PropertySource` ì¶”ê°€
3. ì²˜ìŒ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ í›„ ì´ˆê¸°í™” ê³¼ì •ì—ì„œ Spring Contextì— ë“±ë¡(`Environment`ì— í™˜ê²½ ë³€ìˆ˜ ì €ì¥)

```java
// 2ë²ˆ ê³¼ì •
@Configuration
@ComponentScan{
	basePackages = {"org. ...."}
}
@PropertySource("application.properties") // application.properties ì†ì„±ì„ ê°€ì ¸ì™€ì„œ Environmentì— ì €ì¥í•˜ë„ë¡ í•œë‹¤.
public class AppConfig {
}
```

`Environment`ì—ì„œ `getEnvironment()`ë¥¼ í†µí•´ì„œ propertySourceë“¤ì„ í™•ì¸í•˜ê±°ë‚˜ ì§ì ‘ ì¶”ê°€ ê°€ëŠ¥

```java
// Spring Context ë‚´ ë“±ë¡ëœ Environmentì—ì„œ í™•ì¸ ë° ì¶”ê°€ ê°€ëŠ¥
ConfigurableApplicationContext ctx = new GenericApplicationContext(); // context ìƒì„± ì‹œì ì— ë‚´ë¶€ì—ì„œ `@PropertySource`ë¥¼ ì¸ì‹í•˜ì—¬ ì™¸ë¶€ë¡œë¶€í„° ì„¤ì • ê°’ì„ ê°€ì ¸ì™€ Environmentì— ì €ì¥í•œë‹¤.
MutablePropertySources sources = ctx.getEnvironment().getPropertySources(); 
sources.addFirst(new MyPropertySource()); // ì§ì ‘ ì¶”ê°€í•  ìˆ˜ë„ ìˆìŒ.
```

<details>
  <summary><h3>spring lagacyì—ì„œ yaml ì¸ì‹í•˜ê¸°</h3></summary>
  
ê¸°ë³¸ì ìœ¼ë¡œ `@PropertySource()`ëŠ” `yml`íŒŒì¼ í˜•ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤. 
ê·¸ë˜ì„œ **yml í˜•ì‹ìœ¼ë¡œ ë°”ê¾¸ëŠ” `PropertySourceFactory`ë¥¼ êµ¬í˜„**í•´ì•¼ í•œë‹¤.

Springì—ì„œ `YamlPropertiesFactoryBean()`ì„ ì§€ì›í•œë‹¤. 

```java
public class YamlPropertiesFactory implements PropertySourceFactory {
	@Override
	public PropertySource<?> createPropertySource(String s, EncodedResource encodedResoure) throws IOException {
		var yamlPropertiesFactoryBean = new YamlPropertiesFactoryBean();
yamlPropertiesFactoryBean.setResources(encodedResource.getResource());

	var properties = yamlPropertiesFactoryBean.getObject();
	return new PropertiesPropertySource(encodeResource.getResource(), getFilename(), properties);
	}
}

@Configuration
@ComponentScan{
	basePackages = {"org. ...."}
}
@PropertySource(value = "application.yml", factory = YamlPropertiesFactory.class)
public class AppConfig {
}
```

ë‹¤ìŒê³¼ ê°™ì´ ì¼ì¼ì´ ymlë¡œ ë³€í™˜í•´ì£¼ëŠ” Factoryë¥¼ ë§Œë“¤ê³ , `@PropertySource`ì— ë“±ë¡í•´ì•¼ í•œë‹¤.


[Environment Abstraction - spring framework reference](https://docs.spring.io/spring-framework/reference/core/beans/environment.html#beans-property-source-abstraction)

[YAMLë¡œ í”„ë¡œí¼í‹° ì‘ì„± - yanju](https://velog.io/@leehanju408/YAML%EB%A1%9C-%ED%94%84%EB%A1%9C%ED%8D%BC%ED%8B%B0-%EC%9E%91%EC%84%B1-c3pz7yvb)
</details>

### in spring boot

Spring BootëŠ” ì•„ì˜ˆ ymlì„ ì§€ì›í•˜ë„ë¡ ë³€ê²½ë˜ì—ˆë‹¤.
> `@PropertySource("application.yml)` ê°€ëŠ¥


---

# ì™¸ë¶€ ì„¤ì • ìë™ ì¸ì‹

> Spring Boot configures by default aÂ `PropertySourcesPlaceholderConfigurer`Â bean that will get properties fromÂ `application.properties`Â andÂ `application.yml`Â files.|

spring bootëŠ” `PropertySourcesPlaceholderConfigurer`ë¡œ ì¸í•´ `application`ì´ë€ ì´ë¦„ì˜ properties, yml íŒŒì¼ì— ìˆëŠ” ì„¤ì •ë“¤ì„ ì¸ì‹í•´ì„œ PropertySourceê°ì²´ë¡œ ì¶”ê°€í•´ì¤€ë‹¤.

ì™¸ë¶€ ì„¤ì •ì˜ ìš°ì„  ìˆœìœ„ë¥¼ ê³µì‹ ë¬¸ì„œì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

> **'`@PropertySource`ë¥¼ ì¼ì¼ì´ Configuration ê°ì²´ì— ì¶”ê°€í•  í•„ìš” ì—†ì´, ë°”ë¡œ 'ì£¼ì…(`@Value` ë“±..)'í•˜ë©´ ëœë‹¤.**

---

# ì„¤ì • ê°’ ì£¼ì…

### `@Value`

> `@Value` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ ì™¸ë¶€ propertiesë¡œë¶€í„° ê°’ì„ í•„ë“œì— ì£¼ì…í•  ìˆ˜ ìˆë‹¤.

`@Value("a")`ë¥¼ í•˜ë©´ í•„ë“œì— `"a"`ê°€ ì£¼ì…ëœë‹¤.

ì´ë¥¼ SpELë¡œ í‘œí˜„í•˜ë©´ ì™¸ë¶€ propertiesë¡œë¶€í„° ê°€ì ¸ì˜¬ ìˆ˜ ìˆê²Œ ëœë‹¤.

[UsingÂ `@Value` - spring framework reference](https://docs.spring.io/spring-framework/reference/core/beans/annotation-config/value-annotations.html)

### `@ConfigurationProperties`

ğŸ¤” ì•„ì§ ì‚¬ìš©í•˜ëŠ” ê²½ìš°ë¥¼ ì˜ ë³´ì§€ ëª»í–ˆë‹¤.

> `@Value`ì™€ ë‹¤ë¥´ê²Œ, ì´ë¦„ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ í´ë˜ìŠ¤ ê¸°ì¤€ ëª¨ë“  í•„ë“œì— ë°”ì¸ë”©í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤.

> Not registered via @EnableConfigurationProperties, marked as Spring component, or scanned via @ConfigurationPropertiesScan 

Spring frameworkëŠ” **Config ê°ì²´**ì— `@EnableConfigurationProperties`ë¥¼ ì„ ì–¸í•´ì•¼ í•œë‹¤. ì•„ë‹ˆë©´ ìœ„ì™€ ê°™ì€ ì—ëŸ¬ ë©”ì„¸ì§€ë¥¼ ë§Œë‚  ìˆ˜ ìˆë‹¤.

- `@EnableConfigurationProperties`: `@Component`ë¡œ ë˜ì–´ ìˆëŠ” ê°ì²´ ì¤‘ì—ì„œ `@ConfigurationProperties`ê°€ ì íŒ ê³³ì˜ í•„ë“œê°’ì— ì£¼ì…
- `@ConfigurationPropertiesScan`: ì£¼ì…í•˜ê³  ì‹¶ì€ í´ë˜ìŠ¤ì— ë‹¬ì•„ë†“ìœ¼ë©´ Spring Bootì˜ Scan ëŒ€ìƒì— ì¶”ê°€ë˜ì–´ ì£¼ì…í•´ì¤Œ.

```java
@Getter
@RequiredArgsConstructor
@ConfigurationProperties(prefix = "spring.datasource")
public class DataSourceProperties {

	private final String driverClassName;
	private final String url;
	private final String username;
	private final String password;
}
```

> property ì–‘ì´ ë§ì€ ê²½ìš° `@ConfigurationProperties`ë¥¼ í™œìš©í•˜ê³ , ì–‘ì´ ì ì€ ê²½ìš° `@Value`ë¡œë„ ì¶©ë¶„í•˜ë‹¤.

```java
@Repository  
@Profile("jdbc")  
@RequiredArgsConstructor  
public class VoucherJdbcRepository implements VoucherRepository {    
  
    private final DataSourceProperties dataSourceProperties;
```
ê·¸ë¦¬ê³  ì´ë ‡ê²Œ Beanìœ¼ë¡œ ì£¼ì…ì„ ë°›ìœ¼ë©´ í•„ë“œ ê°’ì— ì£¼ì…ë˜ëŠ” ëª¨ìŠµì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![image](https://github.com/user-attachments/assets/f65241f6-a65a-4aa3-bbdc-f595d53f4df4)

---

[[Spring] @Valueì™€ @ConfigurationPropertiesì˜ ì‚¬ìš©ë²• ë° ì°¨ì´](https://mangkyu.tistory.com/207)

[Externalized Configuration - spring docs](https://docs.spring.io/spring-boot/reference/features/external-config.html)
