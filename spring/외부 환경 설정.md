# ì™¸ë¶€ í™˜ê²½ ì„¤ì •

- ì™¸ë¶€ ëª¨ë“ˆì˜ ì„¤ì •ì— í•„ìš”í•œ ë³€ìˆ˜
- ì–´í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œì— ë…¸ì¶œë˜ê¸°ì— ë¶€ë‹´ìŠ¤ëŸ¬ìš´ ë³€ìˆ˜

# flow

1. ì™¸ë¶€ ì†ì„± ê°’ ì¸ì‹
   
   ì–´í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œ ì™¸ë¶€ ì†ì„± ê°’ì„ ì¸ì‹í•˜ì—¬ `Environment`ì— ì €ì¥í•œë‹¤.
2. ì–´í”Œë¦¬ì¼€ì´ì…˜ì— ì£¼ì…

   í•´ë‹¹ ê°’ë“¤ì„ êº¼ë‚´ì„œ ì–´í”Œë¦¬ì¼€ì´ì…˜ì— ì£¼ì…í•œë‹¤.

---

# ì™¸ë¶€ ì†ì„± ê°’ ì¸ì‹ - `@PropertySource`

### PropertySource
> Springì—ì„œ PropertySoruceë¼ëŠ” ìë£Œêµ¬ì¡°ë¥¼ í†µí•´ ì™¸ë¶€ ì†ì„± ê°’ì„ ì €ì¥í•˜ì—¬ Environment Abstraction ê¸°ëŠ¥ì„ ì§€ì›í•œë‹¤.

ğŸ’¡**ì²˜ìŒ ì–´í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œ ì¸ì‹í•œë‹¤!**

`@PropertySource` ì–´ë…¸í…Œì´ì…˜ì„ `Config` í´ë˜ìŠ¤ì— ì„ ì–¸í•œë‹¤ë©´, 
ì–´í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ Spring Contextê°€ ì™¸ë¶€ ì†ì„±ë“¤ì„ ì¸ì‹í•˜ì—¬ `Environment` ê°ì²´ì— í™˜ê²½ ë³€ìˆ˜ë¡œ ì €ì¥í•œë‹¤.

```java
@Configuration
@ComponentScan{
	basePackages = {"org. ...."}
}
@PropertySource("application.properties") // application.properties ì†ì„±ì„ ê°€ì ¸ì™€ì„œ Environmentì— ì €ì¥í•˜ë„ë¡ í•œë‹¤.
public class AppConfig {
}
```

contextë¥¼ ìƒì„± í›„, `Environment`ì—ì„œ `getEnvironment()`ë¥¼ í†µí•´ì„œ propertySourceë“¤ì„ í™•ì¸í•˜ê±°ë‚˜ ì§ì ‘ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤!

```java
ConfigurableApplicationContext ctx = new GenericApplicationContext(); // context ìƒì„± ì‹œì ì— ë‚´ë¶€ì—ì„œ `@PropertySource`ë¥¼ ì¸ì‹í•˜ì—¬ ì™¸ë¶€ë¡œë¶€í„° ì„¤ì • ê°’ì„ ê°€ì ¸ì™€ Environmentì— ì €ì¥í•œë‹¤.
MutablePropertySources sources = ctx.getEnvironment().getPropertySources(); 
sources.addFirst(new MyPropertySource()); // ì§ì ‘ ì¶”ê°€í•  ìˆ˜ë„ ìˆìŒ.
```

- `.properties` ì¸ì‹
- PropertySources ì¶”ê°€

<details>
  <summary><h3>spring lagacyì—ì„œ yaml ì¸ì‹í•˜ê¸°</h3></summary>
  
ê¸°ë³¸ì ìœ¼ë¡œ `@PropertySource()`ëŠ” `yml`íŒŒì¼ í˜•ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ”ë‹¤. 
ê·¸ë˜ì„œ **yml í˜•ì‹ìœ¼ë¡œ ë°”ê¾¸ëŠ” `PropertySourceFactory`ë¥¼ êµ¬í˜„**í•´ì•¼ í•œë‹¤.

Springì—ì„œ `YamlPropertiesFactoryBean()`ì„ ì§€ì›í•œë‹¤. 

```java
public class YamlPropertiesFactory implements PropertySourceFactory {
	@Override
	public PropertySource<?> createPropertySource(String s, EncodedResource encodedResoure) throws IOException {
		var yamlPropertiesFactoryBean = new YamlPropertiesFactoryBean();
yamlPropertiesFactoryBean.setResources(encodedResource.getResource());

	var properties = yamlPropertiesFactoryBean.getObject();
	return new PropertiesPropertySource(encodeResource.getResource(), getFilename(), properties);
	}
}

@Configuration
@ComponentScan{
	basePackages = {"org. ...."}
}
@PropertySource(value = "application.yml", factory = YamlPropertiesFactory.class)
public class AppConfig {
}
```

ë‹¤ìŒê³¼ ê°™ì´ ì¼ì¼ì´ ymlë¡œ ë³€í™˜í•´ì£¼ëŠ” Factoryë¥¼ ë§Œë“¤ê³ , `@PropertySource`ì— ë“±ë¡í•´ì•¼ í•œë‹¤.


[Environment Abstraction - spring framework reference](https://docs.spring.io/spring-framework/reference/core/beans/environment.html#beans-property-source-abstraction)

[YAMLë¡œ í”„ë¡œí¼í‹° ì‘ì„± - yanju](https://velog.io/@leehanju408/YAML%EB%A1%9C-%ED%94%84%EB%A1%9C%ED%8D%BC%ED%8B%B0-%EC%9E%91%EC%84%B1-c3pz7yvb)
</details>
 



---

# ì†ì„± ê°’ ì£¼ì…

### `@Value`

> `@Value` ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ë©´ ì™¸ë¶€ propertiesë¡œë¶€í„° ê°’ì„ í•„ë“œì— ì£¼ì…í•  ìˆ˜ ìˆë‹¤.

`@Value("a")`ë¥¼ í•˜ë©´ í•„ë“œì— `"a"`ê°€ ì£¼ì…ë˜ëŠ” ê¸°ëŠ¥ì¸ë°, ì´ë¥¼ `${..}`ë¡œ í‘œí˜„í•˜ë©´ ì™¸ë¶€ propertiesë¡œë¶€í„° ê°€ì ¸ì˜¬ ìˆ˜ ìˆê²Œ ëœë‹¤.

ê·¸ í›„ì— `${..}`í‘œí˜„ì„ í†µí•´ ì£¼ì…í•´ì¤„ìˆ˜ ìˆë‹¤.

[UsingÂ `@Value` - spring framework reference](https://docs.spring.io/spring-framework/reference/core/beans/annotation-config/value-annotations.html)

### `@Value` ì–´ë…¸í…Œì´ì…˜ì˜ ì£¼ì… ì‹œì 

> Note that actual processing of the @Value annotation is performed by aÂ **BeanPostProcessor**Â which in turn means that you cannot use @Value withinÂ **BeanPostProcessor**Â orÂ **BeanFactoryPostProcessor**Â types. Please consult the javadoc for theÂ **AutowiredAnnotationBeanPostProcessor**Â class (which, by default, checks for the presence of this annotation).

`Bean`ì˜ ìƒì„± ì‹œì ì´ ì•„ë‹Œ, `BeanPostProcessor`ì—ì„œ ì´ˆê¸°í™” ëœë‹¤. ê·¸ë˜ì„œ `Bean`ì´ ìƒì„±ëœ ì§í›„ì— ì´ˆê¸°í™” ë˜ë¯€ë¡œ ì„œë¡œ ìƒì„± ì‹œì ì´ ë‹¤ë¥´ë‹¤.

```java
// Bean ìƒì„± ì‹œì 
@Value(${image.path})
String path = null;
final String imagePath = FOLDER_PATH + path(ì§€ê¸ˆ nullì„);

// Bean ìƒì„± ì´í›„ PostProcessor ë™ì‘
@Value(${image.path})
String path = "C:/...";
final String imagePath = FOLDER_PATH + path(null ê·¸ëŒ€ë¡œ);
```

ë©”ì„œë“œë¡œ ì°¸ì¡°í•˜ëŠ” ê²ƒì€ ê´œì°®ì§€ë§Œ, ìœ„ì²˜ëŸ¼ í•„ë“œì— ìƒì„±ì ì‹œì ì— ì´ˆê¸°í™”ë˜ëŠ” ë³€ìˆ˜ì¼ ê²½ìš° ì¡°ì‹¬í•´ì„œ ì‚¬ìš©í•˜ì.

### `@ConfigurationProperties`

> `@Value`ì™€ ë‹¤ë¥´ê²Œ, ì´ë¦„ìœ¼ë¡œ êµ¬ë¶„í•˜ì—¬ í´ë˜ìŠ¤ ê¸°ì¤€ ëª¨ë“  í•„ë“œì— ë°”ì¸ë”©í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤.

ğŸ¤” ì‹¤ì œë¡œ ì˜ ì‚¬ìš©í•˜ì§„ ì•ŠëŠ”ë‹¤..

> Not registered via @EnableConfigurationProperties, marked as Spring component, or scanned via @ConfigurationPropertiesScan 

Spring frameworkëŠ” **Config ê°ì²´**ì— `@EnableConfigurationProperties`ë¥¼ ì„ ì–¸í•´ì•¼ í•œë‹¤. ì•„ë‹ˆë©´ ìœ„ì™€ ê°™ì€ ì—ëŸ¬ ë©”ì„¸ì§€ë¥¼ ë§Œë‚  ìˆ˜ ìˆë‹¤.

- `@EnableConfigurationProperties`: `@Component`ë¡œ ë˜ì–´ ìˆëŠ” ê°ì²´ ì¤‘ì—ì„œ `@ConfigurationProperties`ê°€ ì íŒ ê³³ì˜ í•„ë“œê°’ì— ì£¼ì…
- `@ConfigurationPropertiesScan`: ì£¼ì…í•˜ê³  ì‹¶ì€ í´ë˜ìŠ¤ì— ë‹¬ì•„ë†“ìœ¼ë©´ Spring Bootì˜ Scan ëŒ€ìƒì— ì¶”ê°€ë˜ì–´ ì£¼ì…í•´ì¤Œ.

```java
@Getter
@RequiredArgsConstructor
@ConfigurationProperties(prefix = "spring.datasource")
public class DataSourceProperties {

	private final String driverClassName;
	private final String url;
	private final String username;
	private final String password;
}
```

> property ì–‘ì´ ë§ì€ ê²½ìš° `@ConfigurationProperties`ë¥¼ í™œìš©í•˜ê³ , ì–‘ì´ ì ì€ ê²½ìš° `@Value`ë¡œë„ ì¶©ë¶„í•˜ë‹¤.

```java
@Repository  
@Profile("jdbc")  
@RequiredArgsConstructor  
public class VoucherJdbcRepository implements VoucherRepository {    
  
    private final DataSourceProperties dataSourceProperties;
```
ê·¸ë¦¬ê³  ì´ë ‡ê²Œ Beanìœ¼ë¡œ ì£¼ì…ì„ ë°›ìœ¼ë©´ í•„ë“œ ê°’ì— ì£¼ì…ë˜ëŠ” ëª¨ìŠµì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

![image](https://github.com/user-attachments/assets/f65241f6-a65a-4aa3-bbdc-f595d53f4df4)


### **í”„ë¡œíŒŒì¼ë§**

> ì†ì„± ê°’ ì£¼ì…ì˜ ë¶„ë¥˜

íŠ¹ì • ë°ì´í„°ë² ì´ìŠ¤ë¥¼ staging í™˜ê²½ì—ì„œë§Œ ì‚¬ìš©í•˜ê³  ì‹¶ì„ ìˆ˜ ìˆë‹¤. í˜¹ì€ local í™˜ê²½, dev í™˜ê²½ì—ì„œë§Œ ì‚¬ìš©í•˜ê³  ì‹¶ì„ ìˆ˜ ìˆë‹¤.

Springì—ì„œëŠ” ì´ëŸ° íŠ¹ì • ìƒí™©ì— ë§ëŠ” ì„¤ì • íŒŒì¼ì„ ê·¸ë£¹í™” ì‹œí‚¬ ìˆ˜ ìˆëŠ” `Profile`ì´ë¼ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.

```java
var context = new AnnotationConfigApplicationContext(AppConfig.class);
var environment = applicationContext.getEnvironment();
environment.setActiveProfiles("dev");
context.refresh();
```

ê·¸ë˜ì„œ `@Qualifier`ëŒ€ì‹  `@Profile`ì„ í†µí•´ì„œ ì»´í¬ë„ŒíŠ¸ ìŠ¤ìº” ì‹œ ì§ì ‘ í”„ë¡œíŒŒì¼ì„ í™œì„±í™” ì‹œì¼œì„œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆë‹¤.

- `@Component`
- Configì—ì„œ Bean ë©”ì„œë“œ
ì—ì„œ ì¶”ê°€í•  ìˆ˜ ìˆë‹¤.

`@Qualifier`ì— ëŒ€í•œ ë¶€ë¶„ì€ [[ğŸ““ spring Autowired]]ë¶€ë¶„ì„ ì°¸ê³ í•˜ì.

---
# In Spring Boot

### yaml ì¸ì‹ ê°€ëŠ¥

Spring BootëŠ” ì•„ì˜ˆ ymlì„ ì§€ì›í•˜ë„ë¡ ë³€ê²½ë˜ì—ˆë‹¤.

### ì™¸ë¶€ ì„¤ì • ìë™ ì£¼ì…

> Spring Boot configures by default aÂ `PropertySourcesPlaceholderConfigurer`Â bean that will get properties fromÂ `application.properties`Â andÂ `application.yml`Â files.|

spring bootëŠ” `PropertySourcesPlaceholderConfigurer`ë¡œ ì¸í•´ `application`ì´ë€ ì´ë¦„ì˜ properties, yml íŒŒì¼ì— ìˆëŠ” ì„¤ì •ë“¤ì„ ì¸ì‹í•´ì„œ PropertySourceê°ì²´ë¡œ ì¶”ê°€í•´ì¤€ë‹¤.

ì™¸ë¶€ ì„¤ì •ì˜ ìš°ì„  ìˆœìœ„ë¥¼ ê³µì‹ ë¬¸ì„œì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ìì„¸í•œ ì‚¬í•­ì€ [[ğŸ““ springbootê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥]]ì„ ì°¸ê³ í•˜ì.

**ê·¸ë˜ì„œ ì´ëŸ° ê²½ìš° 'ì¸ì‹(`@PropertySource`)'ì˜ ê³¼ì •ì„ ìƒëµí•˜ê³ , ë°”ë¡œ 'ì£¼ì…(`@Value` ë“±..)'í•˜ë©´ ëœë‹¤.**

### yamlì—ì„œì˜ í”„ë¡œíŒŒì¼ë§

> spring boot ì—ì„œëŠ” ì–´í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ì™¸ì—ë„ ymlì—ì„œë„ í”„ë¡œíŒŒì¼ë§ì„ ì´ìš©í•  ìˆ˜ ìˆë‹¤.

```yaml
spring:
  config:
    activate:
      on-profile: local

...

---

spring:
  config:
    activate:
      on-profile: dev

...
```

```java
var springApplication = new SpringApplication(~~Application.class);
environment.setActiveProfiles("dev");
var applicationContext = springApplication.run(args);
```

### IDE í™˜ê²½ë³€ìˆ˜ ë“±ë¡

ì‹¤í–‰í•  ë•Œ IDEì— ì„¤ì •í•˜ë©´, `args`ë¡œ ì§ì ‘ ì „ë‹¬í•´ì£¼ëŠ” ê¸°ëŠ¥

IDEì—ì„œë„ ì‹¤í–‰í•˜ëŠ” ë°©ì‹ì´ ì¼ë°˜ Java Applicationì„ ì‹¤í–‰í•˜ëŠ” ê²ƒê³¼ ì¡°ê¸ˆ ë‹¤ë¥´ë‹¤.

`~~Application`ì„ ì‹¤í–‰í•˜ëŠ” ì„¤ì •ì„ ë“¤ì–´ê°€ë©´, ê¸°ë³¸ args ì„¤ì • ì™¸ì—ë„ environment ì„¤ì •, ì´ì™¸ì—ë„ ë‹¤ì–‘í•œ spring boot ì„¤ì •ì„ í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•œë‹¤.

```
// program arguments(String[] args)
--spring.profile.active=dev
```

ì´ë ‡ê²Œ VM í™˜ê²½ ë³€ìˆ˜ì— ë„£ì–´ë„ ëœë‹¤.

[[Spring Boot appliation.yml ì„¤ì • ëª¨ìŒ]]ì„ ì°¸ê³ í•˜ì.

---

[[Spring] @Valueì™€ @ConfigurationPropertiesì˜ ì‚¬ìš©ë²• ë° ì°¨ì´](https://mangkyu.tistory.com/207)

[Externalized Configuration - spring docs](https://docs.spring.io/spring-boot/reference/features/external-config.html)
